<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Market Data - Day Trader</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Day Trader</h1>
        <h2>Stock Market Data</h2>
        <nav>
          <ul>
            <li><a href="{{ url_for('index') }}" data-ajax="true">Home</a></li>
            <li><a href="{{ url_for('stock.index') }}" data-ajax="true">Stock Services</a></li>
            <li><a href="{{ url_for('data.index') }}" class="active" data-ajax="true">Market Data</a></li>
          </ul>
        </nav>
        <hr/>
      </header>

      <main>
        <section class="form-section">
          <h3>Fetch Stock Market Data</h3>
          <div id="status-message"></div>
          <form id="fetch-data-form">
            <div class="form-group">
              <label for="stock_symbol">Stock Symbol:</label>
              <select id="stock_symbol" name="stock_symbol" required>
                {% for stock in supported_stocks %}
                <option value="{{ stock }}">{{ stock }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="data_type">Data Type:</label>
                <select id="data_type" name="data_type" required>
                  <option value="intraday">Intraday</option>
                  <option value="daily">Daily</option>
                </select>
              </div>
              
              <div class="form-group" id="interval-group">
                <label for="interval">Interval:</label>
                <select id="interval" name="interval">
                  <option value="1m">1 minute</option>
                  <option value="2m">2 minutes</option>
                  <option value="5m">5 minutes</option>
                  <option value="15m">15 minutes</option>
                  <option value="30m">30 minutes</option>
                  <option value="60m">60 minutes</option>
                  <option value="90m">90 minutes</option>
                  <option value="1h">1 hour</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="period">Period:</label>
                <select id="period" name="period" required>
                  <option value="1d">1 day</option>
                  <option value="5d">5 days</option>
                  <option value="1mo">1 month</option>
                  <option value="3mo">3 months</option>
                  <option value="6mo">6 months</option>
                  <option value="1y" selected>1 year</option>
                  <option value="2y">2 years</option>
                  <option value="5y">5 years</option>
                  <option value="10y">10 years</option>
                  <option value="ytd">Year to date</option>
                  <option value="max">Maximum</option>
                </select>
              </div>
            </div>
            
            <div class="button-group">
              <button type="button" data-action="fetch" class="btn btn-primary data-action-btn">Fetch Data</button>
              <button type="button" data-action="save" class="btn btn-success data-action-btn">Fetch & Save to Database</button>
            </div>
          </form>
        </section>

        <section class="data-results">
          <h3 id="results-title">Data Results</h3>
          <div id="data-container">
            <p id="no-data-message">No data fetched yet. Use the form above to retrieve stock market data.</p>
          </div>
        </section>

        <section class="recent-data-records">
          <h3>Recent Database Records</h3>
          <div class="tab-container">
            <div class="tab-buttons">
              <button class="tab-btn active" data-tab="intraday">Intraday Prices</button>
              <button class="tab-btn" data-tab="daily">Daily Prices</button>
            </div>
            <div class="tab-content">
              <div id="intraday-tab" class="tab-pane active">
                <div id="intraday-container">
                  <p id="no-intraday-message">No intraday records found in database.</p>
                </div>
              </div>
              <div id="daily-tab" class="tab-pane">
                <div id="daily-container">
                  <p id="no-daily-message">No daily records found in database.</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      <footer>
        <hr />
        <div class="footer-content">
          <p>Stock market data provided by Yahoo Finance</p>
          <p class="copyright">&copy; {{ now.year }} Alexander J. Slivka</p>
        </div>
      </footer>
    </div>

    <script>
      // Define API endpoints as constants
      const intradayRecordsUrl = "/market-data/database-records/intraday";
      const dailyRecordsUrl = "/market-data/database-records/daily";
      const marketDataApiUrl = "/market-data/api/{symbol}";
      
      // Show/hide interval select based on data type
      document.getElementById('data_type').addEventListener('change', function() {
        const intervalGroup = document.getElementById('interval-group');
        if (this.value === 'intraday') {
          intervalGroup.style.display = 'block';
        } else {
          intervalGroup.style.display = 'none';
        }
      });
      
      // Handle tab switching using event delegation
      document.querySelector('.tab-buttons').addEventListener('click', function(e) {
        if (e.target.classList.contains('tab-btn')) {
          // Remove active class from all buttons and panes
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
          
          // Add active class to clicked button and corresponding pane
          e.target.classList.add('active');
          document.getElementById(e.target.dataset.tab + '-tab').classList.add('active');
        }
      });
      
      // Handle fetch and save button clicks using event delegation
      document.querySelector('.button-group').addEventListener('click', function(e) {
        if (e.target.classList.contains('data-action-btn')) {
          const action = e.target.dataset.action;
          if (action === 'fetch') {
            fetchData(false);
          } else if (action === 'save') {
            fetchData(true);
          }
        }
      });
      
      // Function to fetch data and optionally save to DB
      function fetchData(saveToDb) {
        const symbol = document.getElementById('stock_symbol').value;
        const dataType = document.getElementById('data_type').value;
        const interval = document.getElementById('interval').value;
        const period = document.getElementById('period').value;
        
        // Show loading message
        const statusMessage = document.getElementById('status-message');
        statusMessage.textContent = 'Fetching data...';
        statusMessage.className = 'status-info';
        
        // Construct API endpoint
        let endpoint = marketDataApiUrl.replace('{symbol}', symbol) + '?';
        endpoint += `data_type=${dataType}&period=${period}`;
        if (dataType === 'intraday') {
          endpoint += `&interval=${interval}`;
        }
        if (saveToDb) {
          endpoint += '&save=true';
        }
        
        // Fetch data from API
        fetch(endpoint)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            if (data.error) {
              throw new Error(data.error);
            }
            
            // Show success message
            statusMessage.textContent = saveToDb ? 
              `Successfully fetched and saved ${data.count} records!` : 
              `Successfully fetched ${data.data.length} records!`;
            statusMessage.className = 'status-success';
            
            // Display the data
            displayData(data.data, dataType);
            
            // If we saved to DB, refresh the DB records display
            if (saveToDb) {
              refreshDatabaseRecords();
            }
          })
          .catch(error => {
            // Show error message
            statusMessage.textContent = 'Error: ' + error.message;
            statusMessage.className = 'status-error';
          });
      }
      
      // Function to display fetched data
      function displayData(data, dataType) {
        const container = document.getElementById('data-container');
        const resultsTitle = document.getElementById('results-title');
        
        // Update title
        resultsTitle.textContent = dataType === 'intraday' ? 'Intraday Data Results' : 'Daily Data Results';
        
        // Clear existing data
        container.innerHTML = '';
        
        // If no data, show message
        if (!data || data.length === 0) {
          container.innerHTML = '<p>No data found for the selected parameters.</p>';
          return;
        }
        
        // Create table
        const table = document.createElement('table');
        table.className = 'data-table';
        
        // Create table header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        // Create headers based on data type
        const headers = dataType === 'intraday' ? 
          ['Timestamp', 'Open', 'High', 'Low', 'Close', 'Volume'] : 
          ['Date', 'Open', 'High', 'Low', 'Close', 'Adj Close', 'Volume'];
        
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Create table body
        const tbody = document.createElement('tbody');
        
        // Add data rows (limit to 10 most recent for display)
        const displayData = data.slice(-10);
        
        displayData.forEach(item => {
          const row = document.createElement('tr');
          
          if (dataType === 'intraday') {
            // Format timestamp
            const date = new Date(item.timestamp);
            const formattedDate = date.toLocaleString();
            
            // Add cells
            row.innerHTML = `
              <td>${formattedDate}</td>
              <td>${item.open !== null ? item.open.toFixed(2) : 'N/A'}</td>
              <td>${item.high !== null ? item.high.toFixed(2) : 'N/A'}</td>
              <td>${item.low !== null ? item.low.toFixed(2) : 'N/A'}</td>
              <td>${item.close !== null ? item.close.toFixed(2) : 'N/A'}</td>
              <td>${item.volume !== null ? item.volume.toLocaleString() : 'N/A'}</td>
            `;
          } else {
            // Add cells
            row.innerHTML = `
              <td>${item.date}</td>
              <td>${item.open !== null ? item.open.toFixed(2) : 'N/A'}</td>
              <td>${item.high !== null ? item.high.toFixed(2) : 'N/A'}</td>
              <td>${item.low !== null ? item.low.toFixed(2) : 'N/A'}</td>
              <td>${item.close !== null ? item.close.toFixed(2) : 'N/A'}</td>
              <td>${item.adj_close !== null ? item.adj_close.toFixed(2) : 'N/A'}</td>
              <td>${item.volume !== null ? item.volume.toLocaleString() : 'N/A'}</td>
            `;
          }
          
          tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        container.appendChild(table);
        
        // Show total count if there are more than 10 records
        if (data.length > 10) {
          const countMessage = document.createElement('p');
          countMessage.className = 'data-count';
          countMessage.textContent = `Showing 10 most recent of ${data.length} total records.`;
          container.appendChild(countMessage);
        }
      }
      
      // Function to refresh database records
      function refreshDatabaseRecords() {
        // Fetch intraday records
        fetch(intradayRecordsUrl)
          .then(response => response.json())
          .then(data => {
            displayDatabaseRecords(data, 'intraday');
          })
          .catch(error => console.error('Error fetching intraday records:', error));
        
        // Fetch daily records
        fetch(dailyRecordsUrl)
          .then(response => response.json())
          .then(data => {
            displayDatabaseRecords(data, 'daily');
          })
          .catch(error => console.error('Error fetching daily records:', error));
      }
      
      // Function to display database records
      function displayDatabaseRecords(data, type) {
        const container = document.getElementById(`${type}-container`);
        const noDataMessage = document.getElementById(`no-${type}-message`);
        
        // Clear existing content
        container.innerHTML = '';
        
        // If no data, show message
        if (!data || data.length === 0) {
          container.appendChild(noDataMessage);
          return;
        }
        
        // Create table
        const table = document.createElement('table');
        table.className = 'data-table';
        
        // Create table header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        // Create headers based on data type
        const headers = ['ID', 'Stock', 'Symbol'];
        if (type === 'intraday') {
          headers.push('Timestamp', 'Open', 'High', 'Low', 'Close', 'Volume');
        } else {
          headers.push('Date', 'Open', 'High', 'Low', 'Close', 'Adj Close', 'Volume');
        }
        
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Create table body
        const tbody = document.createElement('tbody');
        
        // Add data rows
        data.forEach(item => {
          const row = document.createElement('tr');
          
          if (type === 'intraday') {
            // Format timestamp
            const date = new Date(item.timestamp);
            const formattedDate = date.toLocaleString();
            
            // Add cells
            row.innerHTML = `
              <td>${item.id}</td>
              <td>${item.stock_name}</td>
              <td>${item.stock_symbol}</td>
              <td>${formattedDate}</td>
              <td>${item.open !== null ? item.open.toFixed(2) : 'N/A'}</td>
              <td>${item.high !== null ? item.high.toFixed(2) : 'N/A'}</td>
              <td>${item.low !== null ? item.low.toFixed(2) : 'N/A'}</td>
              <td>${item.close !== null ? item.close.toFixed(2) : 'N/A'}</td>
              <td>${item.volume !== null ? item.volume.toLocaleString() : 'N/A'}</td>
            `;
          } else {
            // Add cells
            row.innerHTML = `
              <td>${item.id}</td>
              <td>${item.stock_name}</td>
              <td>${item.stock_symbol}</td>
              <td>${item.date}</td>
              <td>${item.open !== null ? item.open.toFixed(2) : 'N/A'}</td>
              <td>${item.high !== null ? item.high.toFixed(2) : 'N/A'}</td>
              <td>${item.low !== null ? item.low.toFixed(2) : 'N/A'}</td>
              <td>${item.close !== null ? item.close.toFixed(2) : 'N/A'}</td>
              <td>${item.adj_close !== null ? item.adj_close.toFixed(2) : 'N/A'}</td>
              <td>${item.volume !== null ? item.volume.toLocaleString() : 'N/A'}</td>
            `;
          }
          
          tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        container.appendChild(table);
      }
      
      // Initialize page by loading recent records
      document.addEventListener('DOMContentLoaded', function() {
        refreshDatabaseRecords();
      });
    </script>
  </body>
</html>
